# 🧾 仕様変更 実装計画

## 🧩 目的

- Codex CLI の会話履歴（`$CODEX_HOME/sessions/.../rollout-*.jsonl`）を読み取り、エディタ領域の WebView で閲覧できる履歴機能を追加する。
- 既存 Explorer 機能へ副作用を与えず、履歴機能を独立して追加する。

## 🔍 変更要件整理

- Codex Core の上部に履歴ボタン（codicon: `history`）を追加する。
- コマンドパレットから会話履歴ビューを起動できるコマンドを追加する。
- 履歴ビューは WebviewPanel でエディタ領域に表示し、単一インスタンスで再利用する。
- `$CODEX_HOME/sessions/年/月/日/rollout-*.jsonl` を読み、左ペインに年/月/日ツリーとセッションカード一覧を表示する。
- セッションカードのタイトルは最初の `user_message` とし、カード先頭に codicon `comment` とローカル時刻 `[H:mm:ss]` を表示する。
- 右ペインは `user_message` と `task_complete.last_agent_message` のみを会話形式で Markdown 表示する。
- 検索はカードタイトルへの大文字小文字区別なし部分一致とし、明示実行（検索ボタンまたは Enter）で絞り込みを行う。
- 絞り込み中は一致語を VS Code テーマ色に追従してハイライトし、クリアで全件表示へ戻す。
- 既存機能（Prompts/Skills/Templates/MCP/Core の既存挙動）に影響を与えない。

## 🛠️ 実装タスク

- 履歴ビュー起動コマンド登録、Codex Core の履歴ボタン追加、WebviewPanel 単一インスタンス制御。
- セッション履歴の走査・解析サービス実装（年/月/日ツリー化、抽出対象イベント限定、ソート、ローカル時刻変換）。
- 履歴 WebView UI 実装（左 30% / 右 70%、カード一覧、会話プレビュー、検索/クリア、テーマ追従ハイライト）。
- WebView と拡張ホスト間のメッセージング実装（初期データ、日付選択、カード選択、検索実行）。
- 仕様準拠テスト追加（単一インスタンス、抽出対象制限、検索一致、表示更新、既存機能非回帰）。

## 🧾 Issue 一覧

- HIST-001: 履歴ビュー起動導線と単一インスタンス制御
- HIST-002: rollout JSONL 解析と履歴インデックス生成
- HIST-003: 履歴 WebView UI（2ペイン/検索/プレビュー）実装
- TEST-001: 会話履歴機能のテスト追加

## ✅ 受け入れ基準

- Codex Core の履歴ボタンとコマンドパレットから同一の履歴ビューを開ける。
- 履歴ビューは WebviewPanel でエディタ領域に表示され、再実行時は既存ビューを前面化する。
- 左ペインは年/月/日ツリーと該当日のセッションカードを新しい順で表示する。
- カードタイトルは最初の `user_message` であり、`[H:mm:ss]` はローカル時刻で表示される。
- 右ペインは `user_message` と `task_complete.last_agent_message` のみを Markdown 表示する。
- 検索はカードタイトルへの部分一致（大文字小文字区別なし）で絞り込み、明示実行で発火する。
- 検索一致語は VS Code テーマ色に追従してハイライトされ、クリアで解除できる。
- 既存 Explorer 機能と同期機能の既存挙動に回帰がない。
