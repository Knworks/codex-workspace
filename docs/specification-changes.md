# 🧾 追加・変更要件

## 🏷️ 概要

Codex CLI の会話履歴（`$CODEX_HOME/sessions/.../rollout-*.jsonl`）を正として読み取り、VS Code の **エディタ領域**に WebView で表示できる UI を追加する。
UI は 1 画面構成で、左ペインに履歴一覧（年/月/日ツリー＋セッションカード）、右ペインに検索結果プレビュー（会話表示＋Markdownプレビュー）を表示する。
検索は **一覧側を絞り込み**、一致箇所を **VS Code テーマ色に追従したハイライト**で表示する。

呼び出しは以下の 2 経路を提供する。

* Codex Core Explorer の上部ボタン（codicon: `history`）
* コマンドパレットからのコマンド実行

既存機能の挙動に影響を与えないこと。

---

## 🎭 ユースケース / ユーザーストーリー

* **U1**：ユーザーは Codex Core Explorer の履歴ボタン（`history`）を押下して、エディタ領域に会話履歴ビューを開ける。
* **U2**：ユーザーはコマンドパレットから会話履歴ビューを開ける。
* **U3**：ユーザーは左ペインの年/月/日ツリーから日付を選び、その配下のセッション一覧（カード）を新しい順で閲覧できる。
* **U4**：ユーザーはセッションカードをクリックすると、右ペインに会話履歴（ユーザー発話と最終回答のみ）が会話形式で表示される。
* **U5**：ユーザーは検索語を入力すると、カードタイトル（最初の user_message）に検索語を含むセッションだけに一覧が絞り込まれ、検索語がハイライト表示される。
* **U6**：ユーザーはクリアボタンで絞り込みを解除し、全件表示に戻せる。

---

## 🧩 機能要件

### 1) 呼び出し導線

* **Codex Core Explorer**

  * 上部に履歴ボタンを追加（codicon：`history`）
  * 押下すると会話履歴ビューを **エディタ領域**に表示する（WebviewPanel）

* **コマンド**

  * コマンドを追加し、実行すると会話履歴ビューを **エディタ領域**に表示する（WebviewPanel）
  * 同一ビューが既に開いている場合は新規作成せず、既存ビューを前面表示する（単一インスタンス）

### 2) データソース / 解析対象

* 履歴データは `$CODEX_HOME/sessions/.../rollout-*.jsonl` を正とする。
* フォルダ階層は `年/月/日` の順で区切られている前提とする。
* ファイル名例：`rollout-2026-02-15T13-26-34-019c5f8c-e283-7a52-9167-726cf8799811.jsonl`

#### 2.1 抽出対象イベント（表示対象）

* 右ペインの会話表示に含めるのは以下のみとする。

  * `type:"event_msg"`, `payload.type:"user_message"` の `payload.message` を「ユーザーの純粋なメッセージ」として扱う
  * `type:"event_msg"`, `payload.type:"task_complete"` の `payload.last_agent_message` を「AIの最終的な回答」として扱う
* **表示しない**

  * システムプロンプト
  * developer 指示
  * AI の思考過程（reasoning）
  * tool 呼び出し/実行ログ等

### 3) 画面構成（WebView 1画面）

* 画面は左右 2 ペインで構成する。

  * 左ペイン：履歴一覧（ツリー＋セッションカード）
  * 右ペイン：検索結果プレビュー（会話表示）
* 幅比率は以下とする。

  * 左 30%
  * 右 70%

### 4) 左ペイン：ツリー＋一覧（セッションカード）

#### 4.1 ツリー構造

* 年/月/日で階層表示する。
* 年/月/日の表示ラベルは次の形式とする。

  * 年：`2026`
  * 月：`02`
  * 日：`15`

#### 4.2 セッションカード一覧

* 選択された「日」配下に、該当日の `rollout-*.jsonl` を **新しい順**でカード表示する。
* カードのタイトルは **最初の user_message のみ**とする。

#### 4.3 カード内表示行（タイトル行の見た目）

* タイトル行の先頭に以下を付与する。

  * アイコン：codicon `comment`
  * 時刻：`event_msg.payload.type:"user_message"` の該当イベントの `timestamp` から取得

    * 表示形式：`[H:mm:ss]`
    * UTC ではなく **ローカル時刻**に変換して表示する
  * メッセージ本文：最初の user_message

* 表示例：`$(comment) [4:26:55] UIやUXを改善するためのスキルを探して`

### 5) 右ペイン：プレビュー（会話表示）

* 左ペインでカードを押下すると、右ペインに該当セッションの履歴を表示する。
* 会話表示は、**user_message を時系列に複数ブロック表示**し、「会話っぽく」見えるUIとする。
* 各 user_message ブロックの後に、当該セッションの最終回答（task_complete の last_agent_message）を表示する。
* 表示は Markdown としてレンダリングし、Markdownプレビュー相当の見た目で表示する。

#### 5.1 ブロック区切り

* 各ブロックの区切りは「余白＋薄い境界線」で表現する。

#### 5.2 スクロール

* 絞り込みで対象件数が減る想定のため、検索一致箇所へのスクロールは不要とする。

### 6) 検索機能

#### 6.1 一致ルール

* 検索語の一致は **単純な部分一致（大文字小文字区別なし）** とする。

#### 6.2 対象

* 検索対象は **カードタイトル（最初の user_message）** のみとする。
* 検索語を含むセッションのみ一覧に表示する（それ以外は非表示）。

#### 6.3 実行タイミング

* 検索は入力のたびではなく、明示実行（例：検索ボタン押下、または Enter）で実行する。

#### 6.4 表示

* 検索結果は「ツリーを絞り込んだ状態」で表示する。
* 絞り込み中は検索語をハイライト表示する。
* クリアボタンで絞り込みを解除する。

#### 6.5 ハイライトのテーマ追従

* ハイライトの見た目（背景色/枠/太字等）は **VS Code のテーマ色に追従**する。

---

## 🛡️ 非機能要件

* 既存機能の挙動に影響を与えないこと（既存Explorerの構造・コマンド・表示更新等に副作用を与えない）。
* 会話履歴ビューは単一インスタンスとし、再実行時は既存ビューを前面に表示してユーザー操作を阻害しない。
* 表示時刻はローカルに変換し、UIとして自然な表記とする。
* VS Code テーマに追従する配色で可読性を担保する。

---

## 🔒 制約事項

* 履歴データの正は `$CODEX_HOME/sessions/.../rollout-*.jsonl` とし、他のデータソース（CLI標準出力や別DB等）は参照しない。
* 表示対象は `user_message` と `task_complete.last_agent_message` のみに限定する（他イベントは表示しない）。
* 会話履歴ビューは WebView を用い、VS Code の **エディタ領域**に表示する（WebViewView は採用しない）。

---
